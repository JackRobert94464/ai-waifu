let characterId = "Q_cHSEbZkD_x5SDCfxHnjh4mIzakJnzsWfqyCvlev7g";

// Port that the NodeJS server will run on.
let port = 40005;

// Nodejs convention
// store the command-line arguments in an array called process.argv
// The first element of this array is always the node executable path, and the second element is always the script file name. 
// Therefore, the actual arguments that the user passes start from the third element, which is index 2.
if (process.argv.length > 3) {
    port = process.argv[3];
    characterId = process.argv[2];
    console.log(`Running on port ${port} with character ${characterId}`);
}

// accept input from console
const readline = require('readline').createInterface({
    input: process.stdin,
    output: process.stdout,
});

// import websocket library
const WebSocket = require('ws');

// import characterai library
const CharacterAI = require('./client');

// create a new instance of the characterai library
const client = new CharacterAI();
global.client = client;

// create a new websocket server
const wss = new WebSocket.Server({ port: port });

/*
    WebSocket API, for debugging purposes.
*/
wss.on('connection', (ws) => {
    console.log('A client connected');

    ws.on('message', async (message) => {
        if (!global.chatRoom) {
            console.log(`Unable to send message.`);
            console.log(`CharacterAI is still fetching character data!`);
            console.log(`If it's taking far too long please submit an issue.`);
            return;
        }

        let chatMessage = message.toString('utf8');
        console.log(`Received message: ${chatMessage}`);

        const response = await global.chatRoom.sendAndAwaitResponse(chatMessage, true);
        console.log(`Character: ${response.text}`);

        ws.send(`${response.text}`);
    });
});



// authenticate with the characterai library
async function main() {
    console.log(`Authenticating....`);
    
    // await client.authenticateAsGuest();
    await client.authenticateWithToken("eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6IkVqYmxXUlVCWERJX0dDOTJCa2N1YyJ9.eyJpc3MiOiJodHRwczovL2NoYXJhY3Rlci1haS51cy5hdXRoMC5jb20vIiwic3ViIjoiZ29vZ2xlLW9hdXRoMnwxMDQ4MDA1NzgwNTY2MDM3MDg4MzciLCJhdWQiOlsiaHR0cHM6Ly9hdXRoMC5jaGFyYWN0ZXIuYWkvIiwiaHR0cHM6Ly9jaGFyYWN0ZXItYWkudXMuYXV0aDAuY29tL3VzZXJpbmZvIl0sImlhdCI6MTY4NDQ4MjYyMSwiZXhwIjoxNjg3MDc0NjIxLCJhenAiOiJkeUQzZ0UyODFNcWdJU0c3RnVJWFloTDJXRWtucVp6diIsInNjb3BlIjoib3BlbmlkIHByb2ZpbGUgZW1haWwifQ.jMeGjkC3Ar-xrPpTkJVpLP08RFhXCJhvAHR2-x6GUBZQNnllHFCEen5prpbF6WbUUXU0mtcocjzl3m-sd8w_49BAsSkD7jTa64vAYPvwTPX6nlJKpGekDry2RCClpcyjwkgzUTzFgEhM9hoCvIHHBL0OdKW8QKMa3XM1VMAN-OU7UoVqlqW0tfKXI16HJDCAkCh_SjyKkhaLFlmMU-IyiLES1OdXekP-kafBlBt9gc_qPK82QjkECNTqCVqDwz9tUExR3EVyar5q8y6Wl4V13mO8a6W5E8PvksheiL018Sw5j43Rnfz5tBOoGxEUzmJQChBghkcyKjZs6bFjcICqRQ");

    console.log(`Authenticated, fetching character AI info....`);

    const characterInfo = await client.fetchCharacterInfo(characterId);
    global.chatRoom = await client.createOrContinueChat(characterId);

    console.log(`Character Name: ${characterInfo.name ?? "<Unknown>"}`);
    console.log(`Greeting: ${characterInfo.greeting ?? "<Unknown>"}`);
    console.log(`Character Id: ${global.chatRoom.characterId ?? "<Unknown>"}`);

    readline.on('line', async (message) => {
        const response = await global.chatRoom.sendAndAwaitResponse(message, true);
        console.log(`Character: ${response.text}`);
    });
}

main();